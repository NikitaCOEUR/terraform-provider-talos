name: acceptance-tests
concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
on:
  pull_request:
    paths:
      - "go.mod"
      - "go.sum"
      - "**.go"

jobs:
  acc-tests:
    if: (!startsWith(github.head_ref, 'renovate/') && !startsWith(github.head_ref, 'dependabot/'))
    runs-on: ubuntu-latest
    env:
      GOTOOLCHAIN: local
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - name: Set up libvirt
        env:
          LIBVIRT_DEFAULT_URI: qemu:///system
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bridge-utils \
            dnsmasq-base \
            libvirt-daemon-system \
            qemu-kvm \
            qemu-utils \
            qemu-block-extra \
            ovmf

          sudo ln -s OVMF_VARS_4M.fd /usr/share/OVMF/OVMF_VARS.fd
          sudo ln -s OVMF_CODE_4M.fd /usr/share/OVMF/OVMF_CODE.fd

          # Configure libvirt security (disable apparmor/selinux for QEMU)
          echo 'security_driver = "none"' | sudo tee --append /etc/libvirt/qemu.conf

          # Restart libvirtd to apply security config (may have auto-started during package install)
          sudo systemctl restart libvirtd || sudo systemctl start libvirtd
          echo -e "<pool type='dir'>\n<name>default</name>\n<target>\n<path>/pool-default</path>\n</target>\n</pool>" > pool.xml
          sudo mkdir /pool-default
          sudo chmod a+rwx /pool-default
          sudo virsh pool-define pool.xml
          sudo virsh pool-start default
          cat <<EOF > net.xml
          <network>
            <name>default</name>
            <bridge name='virbr0'/>
            <mtu size="1350"/>
            <forward/>
            <ip address='192.168.122.1' netmask='255.255.255.0'>
              <dhcp>
                <range start='192.168.122.2' end='192.168.122.254'/>
              </dhcp>
            </ip>
          </network>
          EOF
          sudo virsh net-destroy default
          sudo virsh net-undefine default
          sudo virsh net-create net.xml
      - name: acceptance-test
        env:
          TERRAFORM_LIBVIRT_TEST_DOMAIN_TYPE: qemu
          LIBVIRT_DEFAULT_URI: qemu:///system
          CI: "true"
        run: |
          make testacc # TESTS=TestAccTalosMachineConfigurationApplyResource

      # DEBUG: Run staged tests separately with detailed output
      - name: debug-staged-tests
        if: always()
        env:
          TERRAFORM_LIBVIRT_TEST_DOMAIN_TYPE: qemu
          LIBVIRT_DEFAULT_URI: qemu:///system
          CI: "true"
        run: |
          echo "=== Running staged_if_needing_reboot debug tests ==="
          make testacc-staged || true

      - name: Upload debug logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            testacc-*.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Show libvirt status on failure
        if: failure()
        run: |
          echo "=== libvirt status ==="
          sudo virsh list --all || true
          echo "=== libvirt networks ==="
          sudo virsh net-list --all || true
          echo "=== libvirt pools ==="
          sudo virsh pool-list --all || true
          echo "=== dmesg (last 100 lines) ==="
          sudo dmesg | tail -100 || true
